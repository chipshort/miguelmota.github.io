<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>My New Hugo Site  | Getting started with Service Workers</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.52" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.d98f2eb6bcd1eaedb7edf166bd16af26.css" rel="stylesheet">
    

    

    
      
    

    

    <meta property="og:title" content="Getting started with Service Workers" />
<meta property="og:description" content="Learn how to use the Service Workers API to cache files." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/blog/getting-started-with-service-workers/" /><meta property="article:published_time" content="2016-01-27T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2016-01-27T00:00:00&#43;00:00"/>

<meta itemprop="name" content="Getting started with Service Workers">
<meta itemprop="description" content="Learn how to use the Service Workers API to cache files.">


<meta itemprop="datePublished" content="2016-01-27T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2016-01-27T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="1398">



<meta itemprop="keywords" content="JavaScript,HTML5,Service Workers," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Getting started with Service Workers"/>
<meta name="twitter:description" content="Learn how to use the Service Workers API to cache files."/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="http://example.org/" class="f3 fw2 hover-white no-underline white-90 dib">
      My New Hugo Site
    </a>
    <div class="flex-l items-center">
      

      
      











    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        BLOGS
      </p>
      <h1 class="f1 athelas mb1">Getting started with Service Workers</h1>
      
      <time class="f6 mv4 dib tracked" datetime="2016-01-27T00:00:00Z">January 27, 2016</time>
      
      
    </header>

    <section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l">

<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API">Service Workers</a> enables the ability to cache files for offline use, serve as a network proxy, enable the ability for push notification, and even background data sync. <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Using_the_application_cache">AppCache</a> was an attempt to solve this problem but it made many assumptions about intended uses and in the end just caused more <a href="http://alistapart.com/article/application-cache-is-a-douchebag">fustration</a> than anything, so it became deprecated. Service Workers is AppCache&rsquo;s successor, which greatly superceeds it by giving the developer a lot more granular control.</p>

<p>I will be walking you through a quick tutorial on using service workers for caching assets.</p>

<h2 id="offline-first">Offline First</h2>

<p>With an offline first approach, the browser can serve up a cached version of your site first before reaching out to the network for more data. It&rsquo;s the same approach that native mobile application use which gives the impression that the app is ready to use as soon as you open it.</p>

<h2 id="service-worker-lifecycle">Service Worker Lifecycle</h2>

<ol>
<li>First the service worker must be registered. The application must be served under <code>HTTPS</code> otherwise it will not register, unless it is on localhost.</li>
<li>When registered successfully the service worker is executed in it&rsquo;s own <a href="https://developer.mozilla.org/en1.US/docs/Web/API/ServiceWorkerGlobalScope">context</a>. It is similar to the main thread context except there is no DOM access.</li>
<li>The browser will proceed to install assets to the cache specified by the service worker.</li>
<li>If install is successful then the service worker is activated and can control pages.</li>
</ol>

<h2 id="registering-service-worker">Registering Service Worker</h2>

<p>We register the service worker with <a href="https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorkerContainer/register">serviceWorkerContainer.register()</a> and pass the path of the service worker file.</p>

<p>The service worker path needs to be relative to the site&rsquo;s origin, rather than the directory it is in. the service worker file must be hosted under the same origin therefore it cannot be from a different origin.</p>

<pre><code class="language-javascript">// Feature detection for service worker
if ('serviceWorker' in navigator) {

  // Service worker to register for this site
  navigator.serviceWorker.register('/scripts/service-worker.js', {

    // Constrain access to a certain path
    scope: '/'
  }).then((serviceWorkerRegistration) =&gt; {
    console.log(`Service worker registered with scope ${serviceWorkerRegistration.scope}`);
  }).catch((error) =&gt; {
    console.log(`Service worker registration error: ${error}`);
  });
}
</code></pre>

<p>Here <code>scope</code> constrains the service worker to only control the specified contents under that path. The <code>scope</code> property is optional and defaults to the entire site.</p>

<h2 id="caching-files">Caching Files</h2>

<p>Service Workers come with a storage API called <a href="https://developer.mozilla.org/en-US/docs/Web/API/Cache">cache</a>. The API persists the cached files until we tell it not to cache.</p>

<p>In <code>service-worker.js</code>:</p>

<pre><code class="language-javascript">self.addEventListener('install', (event) =&gt; {
  event.waitUntil(

    // Open a cache store called `v1`
    caches.open('v1').then((cache) =&gt; {

      // Cache all these files
      return cache.addAll([
        '/',
        '/index.html',
        '/styles/index.css',
        '/scripts/index.js',
        '/images/js.png',
        '/images/not-found.png'
      ]);
    })
  );
});
</code></pre>

<p>The <code>install</code> event is fired when it has successfully completed the install.</p>

<p>Here <a href="https://developer.mozilla.org/en-US/docs/Web/API/ExtendableEvent/waitUntil"><code>event.waitUntil()</code></a> takes a promise which is used to determine if all the files successfully installed. The service worker will only install if every file is properly cached.</p>

<p>The <a href="https://developer.mozilla.org/en-US/docs/Web/API/CacheStorage/open">caches.open()</a> method takes a name for the cache, and returns a promise for the created cache.</p>

<p>If it was able to successfully create the cache then we add assets using <a href="https://developer.mozilla.org/en-US/docs/Web/API/Cache/addAll">cache.addAll()</a> which takes an array of file paths relative to the origin.</p>

<p>If all the promises resolve then the service worker activates.</p>

<p>If any of these promises get rejected then the service worker will not install.</p>

<h2 id="serving-cached-files">Serving Cached Files</h2>

<p>To make use of the cache we need to serve the cached files when there is a request to the file.</p>

<p>In <code>service-worker.js</code>:</p>

<pre><code class="language-javascript">self.addEventListener('fetch', (event) =&gt; {
  event.respondWith(

    // Return cached file if it exists
    caches.match(event.request).catch(() =&gt; {

      // Otherwise make network request to fetch file
      return fetch(event.request);
    });
  );
});
</code></pre>

<p>The <code>fetch</code> event is fired whenever the resource under the service worker&rsquo;s scope is fetched.</p>

<p>We use <code>event.respondWith()</code> to hijack the HTTP response and be able to serve something else.</p>

<p>The <a href="https://developer.mozilla.org/en-US/docs/Web/API/Cache/match"><code>catches.match()</code></a> method takes filenames to retrieve from it&rsquo;s cache, which in this case <code>event.request</code> is the request object. If the cache is a miss then we want to go ahead and make an HTTP request to retrieve the file using the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">fetch</a> API, otherwise the <code>caches.match</code> promise will be rejected and the resource will come up as not found in the network.</p>

<h2 id="saving-new-files-to-cache">Saving New Files to Cache</h2>

<p>After we fetch a file that is not in the cache we can store it in the cache so future requests can avoid making the round-trip to the network.</p>

<pre><code class="language-javascript">self.addEventListener('fetch', (event) =&gt; {
  event.respondWith(

    // Return cached file if it exists
    caches.match(event.request).catch(() =&gt; {

      // Otherwise make network request to fetch file
      return fetch(event.request);
    }).then((response) =&gt; {

      // If fetch successful then cache it
      if (response.ok) {
        caches.open('v1').then((cache) =&gt; {
          cache.put(event.request, response);
        });
        return response.clone();
      }

      // Otherwise reject to proceed to catch callback
      return Promise.reject();
    }).catch(() =&gt; {

      // Serve default file if it has an image extension
      if (/(\.png|\.jpg)$/.test(event.request.url)) {
        return caches.match('/images/not-found.png');
      }
    })
  );
});
</code></pre>

<p>As you can see we have augmented our code from before.</p>

<p>If the fetch was successful then We open the cache and store the new file using <a href="https://developer.mozilla.org/en-US/docs/Web/API/Cache/put"><code>cache.put()</code></a> which takes a request object and a <a href="https://developer.mozilla.org/en-US/docs/Web/API/Response">response</a> object.</p>

<p>Response objects can only be read once so we need to clone it with <a href="https://developer.mozilla.org/en-US/docs/Web/API/Response/clone">response.clone()</a> and use the original response for the cache.</p>

<p>If fetch failed then we serve the user a default image.</p>

<h2 id="updating-service-worker">Updating Service Worker</h2>

<p>The client will keep using the same version of the service worker until there are no more pages keeping a reference to it. New versions of service workers are downloaded in the background on page refreshes but not activated. When the service worker is freed up then the latest version will be activated. Make sure to use a different cache key and update the cache install file list per your requirements.</p>

<h2 id="deleting-old-caches">Deleting Old Caches</h2>

<p>The place to delete previous versions of the cache in the <code>activate</code> handler.</p>

<p>In <code>service-worker.js</code>;</p>

<pre><code class="language-javascript">self.addEventListener('activate', function(event) {
  var cacheWhitelist = ['v2'];

  event.waitUntil(
    caches.keys().then(function(keyList) {
      return Promise.all(keyList.map(function(key) {
        if (cacheWhitelist.indexOf(key) === -1) {
          return caches.delete(key);
        }
      }));
    })
  )
});
</code></pre>

<p>We get all the keys of the cache and iterate over them, deleting the caches the do not match the versions in the whitelist.</p>

<h2 id="sending-and-receiving-messages">Sending and Receiving Messages</h2>

<p>Service workers provide a <a href="https://developer.mozilla.org/en-US/docs/Web/API/Clients">clients</a> object which represents a container for service worker <a href="https://developer.mozilla.org/en-US/docs/Web/API/Client">client</a> objects. Clients are open pages currently controlled by the service worker.</p>

<p>To broadcast a message from the service worker to all the pages we use <a href="https://developer.mozilla.org/en-US/docs/Web/API/Client/postMessage"><code>postMessage()</code></a>.</p>

<p>In <code>service-worker.js</code>:</p>

<pre><code class="language-javascript">// Broadcast to all open clients
self.clients.matchAll().then((clients) =&gt; {
  clients.map((client) =&gt; {
    return client.postMessage('This is message is from service worker.');
  })
});
</code></pre>

<p>Bind to the <a href="https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorkerContainer/onmessage"><code>messsage</code></a> event on the main to thread to receive the messages from service worker:</p>

<pre><code class="language-javascript">navigator.serviceWorker.addEventListener('message', (event) =&gt; {
  console.log(`Received message from service worker: ${event.data}`);
});
</code></pre>

<p>Now to send message from the main thread to service worker we follow the same pattern.</p>

<p>In main thread:</p>

<pre><code class="language-javascript">navigator.serviceWorker.controller.postMessage('This is a message from main thread.');
</code></pre>

<p>Make sure to post messages only after the service worker has been activated, other the controller object will be <code>null</code>.</p>

<p>To receive message in <code>service-worker.js</code>:</p>

<pre><code class="language-javascript">self.addEventListener('message', (event) =&gt; {
  console.log(`Received message from main thread: ${event.data}`);
});
</code></pre>

<h3 id="direct-messages">Direct messages</h3>

<p>If we want to send messages to the service worker but only respond to the sender rather than broadcasting then it gets a bit complex.</p>

<pre><code class="language-javascript">function sendMessage(message) {
  return new Promise((resolve, reject) =&gt; {

    // Create a new message channel object
    const messageChannel = new MessageChannel();

    // Bind to `message` listener
    messageChannel.port1.onmessage = (event) =&gt; {
      resolve(`Received direct message from service worker: ${event.data}`);
    };

    // Send the message
    navigator.serviceWorker.controller.postMessage(message, [messageChannel.port2])
  });
}
</code></pre>

<p>First we need to create a new <a href="https://developer.mozilla.org/en-US/docs/Web/API/MessageChannel">MessageChannel</a> object. A message channel is basically a pipe with a port on each end.</p>

<p>Then we bind a listener to the message event on the first message channel port. When posting a message we pass a reference to second port of message channel that the service woker can reply to the specific client.</p>

<p>In <code>service-worker.js</code>:</p>

<pre><code class="language-javascript">self.addEventListener('message', (event) =&gt; {
  console.log(`Received message from main thread: ${event.data}`);

  // ports[0] is a reference of `port2` that we passed
  event.ports[0].postMessage(`Got message! Sending direct message back - &quot;${event.data}&quot;`);
});
</code></pre>

<h2 id="debugging-service-workers">Debugging Service Workers</h2>

<p>To debug in Google Chrome head to <code>chrome://inspect/#service-workers</code> in the browser url bar. There it will display service worker activity such as requests and storage. To start and stop service workers as well as see detailed information head to <code>chrome://serviceworker-internals</code>.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Service workers give you granular control over caching, the ability to hijack requests, and notify clients with messages. Hope you found this guide useful. Check out the full example code on github at <a href="https://github.com/miguelmota/service-worker-example">miguelmota/service-worker-example</a>.</p>
<ul class="pa0">
  
   <li class="list">
     <a href="/tags/javascript" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">JavaScript</a>
   </li>
  
   <li class="list">
     <a href="/tags/html5" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">HTML5</a>
   </li>
  
   <li class="list">
     <a href="/tags/service-workers" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Service Workers</a>
   </li>
  
</ul>
<div class="mt6">
        
      </div>
    </section>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/blog/screenshots-with-getusermedia-api/">Screenshots with getUserMedia API</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/basic-html5-audio-manipulation/">Basic HTML5 Audio Manipulation</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/bytes/canvas-glowing-particles/">How to create glowing particles in canvas</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/bytes/buffer-to-arraybuffer/">How to convert a Buffer to ArrayBuffer</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/bytes/arraybuffer-to-buffer/">How to convert an ArrayBuffer to Buffer</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/bytes/slice-audiobuffer/">How to slice an AudioBuffer</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/bytes/babylonian-method/">How to calculate the square root using Babylonian method.</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/bytes/base-log/">How to find the logarithm of a number with specified base</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/bytes/array-difference/">How to find the difference between arrays</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/bytes/array-balance-points/">How to find the balance points of an array</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/bytes/digit-sum/">How to sum the digits of a number</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/bytes/array-without/">How to create an array excluding provided values</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/bytes/jshintrc/">.jshintrc boilerplate example</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/bytes/webgl-detect/">How to detect WebGL support</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/bytes/array-min/">How to find the minimum value in an array</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://example.org/" >
    &copy; 2019 My New Hugo Site
  </a>
    <div>










</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
