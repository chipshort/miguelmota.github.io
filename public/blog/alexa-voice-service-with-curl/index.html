<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>My New Hugo Site  | Alexa Voice Service (AVS) with cURL</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.52" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.d98f2eb6bcd1eaedb7edf166bd16af26.css" rel="stylesheet">
    

    

    
      
    

    

    <meta property="og:title" content="Alexa Voice Service (AVS) with cURL" />
<meta property="og:description" content="Learn how to interact with Alexa Voice Service (AVS) RESTful API with cURL." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/blog/alexa-voice-service-with-curl/" /><meta property="article:published_time" content="2016-01-17T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2016-01-17T00:00:00&#43;00:00"/>

<meta itemprop="name" content="Alexa Voice Service (AVS) with cURL">
<meta itemprop="description" content="Learn how to interact with Alexa Voice Service (AVS) RESTful API with cURL.">


<meta itemprop="datePublished" content="2016-01-17T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2016-01-17T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="1191">



<meta itemprop="keywords" content="AVS,Alexa,Amazon,cURL," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Alexa Voice Service (AVS) with cURL"/>
<meta name="twitter:description" content="Learn how to interact with Alexa Voice Service (AVS) RESTful API with cURL."/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="http://example.org/" class="f3 fw2 hover-white no-underline white-90 dib">
      My New Hugo Site
    </a>
    <div class="flex-l items-center">
      

      
      











    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        BLOGS
      </p>
      <h1 class="f1 athelas mb1">Alexa Voice Service (AVS) with cURL</h1>
      
      <time class="f6 mv4 dib tracked" datetime="2016-01-17T00:00:00Z">January 17, 2016</time>
      
      
    </header>

    <section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l">

<p>The <a href="https://developer.amazon.com/avs">Alexa Voice Service (AVS)</a> is an Amazon service which lets you interact with <a href="https://developer.amazon.com/alexa">Alexa</a> by sending requests in audio format. This means that we can create our own <a href="https://en.wikipedia.org/wiki/Amazon_Echo">Amazon Echo</a> by just having a microphone and a speaker available. The easiest way to get started is with a <em>hello world</em> example using <a href="https://en.wikipedia.org/wiki/CURL">cURL</a>.</p>

<p>But before we jump to it cURL we have to generate our test audio first.</p>

<h2 id="generate-sample-audio">Generate sample audio</h2>

<p>The audio <strong>MUST</strong> be <strong><em>mono channel</em></strong>, <strong><em>sampled at 16k Hz</em></strong>, and <strong><em>signed 16 bit PCM encoding</em></strong>. Otherwise AVS will send back a blank response.</p>

<h3 id="using-sox">Using SoX</h3>

<p>There is a fantastic command line tool available called <a href="http://sox.sourceforge.net/sox.html">SoX</a> for recording as well as converting audio to specified formats.</p>

<h4 id="recording-audio">Recording audio</h4>

<p>We can record audio right from our terminal like in this example:</p>

<pre><code class="language-bash">$ sox -d -c 1 -r 16000 -e signed -b 16 hello.wav

Input File     : 'default' (coreaudio)
Channels       : 2
Sample Rate    : 44100
Precision      : 32-bit
Sample Encoding: 32-bit Signed Integer PCM

In:0.00% 00:00:01.72 [00:00:00.00] Out:25.8k [      |      ]        Clip:0
</code></pre>

<p>Alternatively, we can use the <code>rec</code> command instead of <code>sox -d</code>.</p>

<h4 id="playing-audio">Playing audio</h4>

<p>SoX comes with a <code>play</code> command for doing exactly what it says. Here an example where we pipe the audio contents:</p>

<pre><code class="language-bash">$ cat hello.wav | play -
-: (wav)

  Encoding: Signed PCM
  Channels: 1 @ 16-bit
  Samplerate: 16000Hz
  Replaygain: off
  Duration: 00:00:01.44

In:100%  00:00:01.44 [00:00:00.00] Out:63.3k [   -==|==-   ] Hd:0.0 Clip:1
play WARN rate: rate clipped 1 samples; decrease volume?
Done.
</code></pre>

<p>We can see that the audio sample rate and encoding are exactly what we need.</p>

<h4 id="converting-audio">Converting audio</h4>

<p>We can use SoX to change the sample rate, encoding, and number of channels. Here is an example where we transform the audio into the format required by AVS:</p>

<pre><code class="language-bash">$ cat hello_stero.wav | sox - -c 1 -r 16000 -e signed -b 16 hello.wav
</code></pre>

<p>The <code>-</code> means to use standard input (stdin) as the audio source.</p>

<h3 id="using-audacity">Using Audacity</h3>

<p>We can use the program <a href="http://audacityteam.org/">Audacity</a> to create sample audio to test with. Here I have highlighted the properties we need to configure.</p>

<p><a href="{{ .Site.BaseURL }}/audacity-mono-16khz.png"><img src="{{ .Site.BaseURL }}/audacity-mono-16khz.png" alt="" /></a></p>

<p><a href="{{ .Site.BaseURL }}/audacity-export-16bit-pcm.png"><img src="{{ .Site.BaseURL }}/audacity-export-16bit-pcm.png" alt="" /></a></p>

<p>Save the audio with extension <code>.wav</code>.</p>

<h2 id="creating-curl-request">Creating cURL request</h2>

<p>The <a href="https://developer.amazon.com/public/solutions/alexa/alexa-voice-service/rest/speechrecognizer-requests">AVS Speechrecognizer Requests API</a> page shows an example of what kind of request we should send. As you can see it is a multipart request with one of the parts being the binary audio data.</p>

<pre><code>POST /v1/avs/speechrecognizer/xxxxxxxxxxxx HTTP/1.1

Host: access-alexa-na.amazon.com
Authorization: Bearer xxxxxxxxxxxx
Content-Type: multipart/form-data; boundary=boundary_term
Transfer-Encoding: chunked

--boundary_term
Content-Disposition: form-data; name=&quot;request&quot;
Content-Type: application/json; charset=UTF-8

{
    &quot;messageHeader&quot;: {
        &quot;deviceContext&quot;: [
            {
                &quot;name&quot;: &quot;playbackState&quot;,
                &quot;namespace&quot;: &quot;AudioPlayer&quot;
                &quot;payload&quot;: {
                    &quot;streamId&quot;: &quot;xxxxxxxxxxxx&quot;,
                    &quot;offsetInMilliseconds&quot;: xxxxxxxxxxxx,
                    &quot;playerActivity&quot;: &quot;xxxxxxxxxxxx&quot;
                }
            },
            {
                ...
            },
            ...
        ]
    },
    &quot;messageBody&quot;: {
        &quot;profile&quot;: &quot;alexa-close-talk&quot;,
        &quot;locale&quot;: &quot;en-us&quot;,
        &quot;format&quot;: &quot;audio/L16; rate=16000; channels=1&quot;
    }
}

--boundary_term
Content-Disposition: form-data; name=&quot;audio&quot;
Content-Type: audio/L16; rate=16000; channels=1

...encoded_audio_data...

--boundary_term--
</code></pre>

<p>Here I have created this is a basic bash script that composes the cURL command. I walk us through the steps in the comments to clarify what is going on. Also if you have not already, you will need an authentication token which you can get by following this <a href="https://developer.amazon.com/public/solutions/alexa/alexa-voice-service/docs/authorizing-your-alexa-enabled-product-from-a-website">Authorizing Your Alexa-enabled Product from a Website</a> guide.</p>

<pre><code class="language-bash">############################################################
# First we creat a bunch of variables to hold data.
############################################################

# Auth token (replace with yours).
TOKEN=&quot;Atza|IQEBLjAsAhR...&quot;

# Boundary name, must be unique so it does not conflict with any data.
BOUNDARY=&quot;BOUNDARY1234&quot;
BOUNDARY_DASHES=&quot;--&quot;

# Newline characters.
NEWLINE='\r\n';

# Metadata headers.
METADATA_CONTENT_DISPOSITION=&quot;Content-Disposition: form-data; name=\&quot;metadata\&quot;&quot;;
METADATA_CONTENT_TYPE=&quot;Content-Type: application/json; charset=UTF-8&quot;;

# Metadata JSON body.
METADATA=&quot;{\
\&quot;messageHeader\&quot;: {},\
\&quot;messageBody\&quot;: {\
\&quot;profile\&quot;: \&quot;alexa-close-talk\&quot;,\
\&quot;locale\&quot;: \&quot;en-us\&quot;,\
\&quot;format\&quot;: \&quot;audio/L16; rate=16000; channels=1\&quot;\
}\
}&quot;

# Audio headers.
AUDIO_CONTENT_TYPE=&quot;Content-Type: audio/L16; rate=16000; channels=1&quot;;
AUDIO_CONTENT_DISPOSITION=&quot;Content-Disposition: form-data; name=\&quot;audio\&quot;&quot;;

# Audio filename (replace with yours).
AUDIO_FILENAME=&quot;hello.wav&quot;

############################################################
# Then we start composing the body using the variables.
############################################################

# Compose the start of the request body, which contains the metadata headers and
# metadata JSON body as the first part of the multipart body.
# Then it starts of the second part with the audio headers. The binary audio
# will come later as you will see.
POST_DATA_START=&quot;
${BOUNDARY_DASHES}${BOUNDARY}${NEWLINE}${METADATA_CONTENT_DISPOSITION}${NEWLINE}\
${METADATA_CONTENT_TYPE}\
${NEWLINE}${NEWLINE}${METADATA}${NEWLINE}${NEWLINE}${BOUNDARY_DASHES}${BOUNDARY}${NEWLINE}\
${AUDIO_CONTENT_DISPOSITION}${NEWLINE}${AUDIO_CONTENT_TYPE}${NEWLINE}&quot;

# Compose the end of the request body, basically just adding the end boundary.
POST_DATA_END=&quot;${NEWLINE}${NEWLINE}${BOUNDARY_DASHES}${BOUNDARY}${BOUNDARY_DASHES}${NEWLINE}&quot;

############################################################
# Now we create a request body file to hold everything including the binary audio data.
############################################################

# Write metadata to a file which will contain the multipart request body content.
echo -e $POST_DATA_START &gt; multipart_body.txt

# Here we append the binary audio data to request body file
# by spitting out the contents. We do it this way so that
# the encoding do not get messed with.
cat $AUDIO_FILENAME &gt;&gt; multipart_body.txt

# Then we append closing boundary to request body file.
echo -e $POST_DATA_END &gt;&gt; multipart_body.txt

############################################################
# Finally we get to compose the cURL request command
# passing it the generated request body file as the multipart body.
############################################################

# Compose cURL command and write to output file.
curl -X POST \
  -H &quot;Authorization: Bearer ${TOKEN}&quot; \
  -H &quot;Content-Type: multipart/form-data; boundary=${BOUNDARY}&quot; \
  --data-binary @multipart_body.txt \
  https://access-alexa-na.amazon.com/v1/avs/speechrecognizer/recognize \
  &gt; response.txt
</code></pre>

<p>Save the contents to <code>request.sh</code>, make it executable, and run it:</p>

<pre><code class="language-bash">$ chmod aug+x request.sh

$ ./request.sh
</code></pre>

<p>If all went well we should get a response similar to this one:</p>

<pre><code>--a7ed2d26-a20f-474a-b4be-a589e1130d1e
Content-Type: application/json

{&quot;messageHeader&quot;:{},&quot;messageBody&quot;:{&quot;directives&quot;:[{&quot;namespace&quot;:&quot;SpeechSynthesizer&quot;,&quot;name&quot;:&quot;speak&quot;,&quot;payload&quot;:{&quot;contentIdentifier&quot;:&quot;amzn1.as-ct.v1.Domain:Application:Knowledge#ACRI#KnowledgePrompt.ab324d01-e5de-4945-8606-a1f03fdc7df0&quot;,&quot;audioContent&quot;:&quot;cid:KnowledgePrompt.ab324d01-e5de-4945-8606-a1f03fdc7df0_1560908845&quot;}}]}}
--a7ed2d26-a20f-474a-b4be-a589e1130d1e
Content-ID: &lt;KnowledgePrompt.ab324d01-e5de-4945-8606-a1f03fdc7df0_1560908845&gt;
Content-Type: audio/mpeg

...encoded_audio_data...
--a7ed2d26-a20f-474a-b4be-a589e1130d1e--
</code></pre>

<p>As you can definitely tell, I am no bash expert but this does get the job done.</p>

<h2 id="playing-mp3-audio">Playing MP3 audio</h2>

<p>The tool <a href="http://www.mpg123.de/">mpg123</a> lets you play MP3 audio from the terminal. In order to extract the MP3 audio data from the response we need to use an HTTP message parser. Here is one that I wrote, <a href="https://github.com/miguelmota/http-message-parser">http-message-parser</a>, which lets you pipe the response and pipe out the parts that we want.</p>

<p>Pipe MP3 data to mpg123 player:</p>

<pre><code class="language-bash">$ cat response.txt | http-message-parser --pick=multipart[1].body | mpg123 -

High Performance MPEG 1.0/2.0/2.5 Audio Player for Layers 1, 2 and 3
        version 1.22.4; written and copyright by Michael Hipp and others
        free software (LGPL) without any warranty but with best wishes

Playing MPEG stream 1 of 1: - ...

MPEG 2.0 layer III, 48 kbit/s, 24000 Hz mono

[0:02] Decoding of - finished.
</code></pre>

<h2 id="update-jan-18-2016-easier-way-to-make-request">Update Jan 18 2016 - Easier way to make request</h2>

<p>I recently stumbled across a much cleaner way of initiating the request. Here it is:</p>

<p><code>metadata.json</code></p>

<pre><code class="language-json">{
  &quot;messageHeader&quot;: {},
  &quot;messageBody&quot;: {
    &quot;profile&quot;: &quot;alexa-close-talk&quot;,
    &quot;locale&quot;: &quot;en-us&quot;,
    &quot;format&quot;: &quot;audio/L16; rate=16000; channels=1&quot;
  }
}
</code></pre>

<p><code>request.sh</code></p>

<pre><code class="language-bash">TOKEN=&quot;Atza|IQEBLjAsAhR...&quot;

curl -i \
  -H &quot;Authorization: Bearer ${TOKEN}&quot; \
  -F &quot;metadata=&lt;metadata.json;type=application/json; charset=UTF-8&quot; \
  -F &quot;audio=&lt;hello.wav;type=audio/L16; rate=16000; channels=1&quot; \
  -o response.txt \
  https://access-alexa-na.amazon.com/v1/avs/speechrecognizer/recognize \
</code></pre>

<p>The <code>-i</code> flag means to output the response headers. The <code>-H</code> flag specifies headers. The <code>-F</code> flag causes cURL to send a POST <code>multipart/form-data</code> request and <code>&lt;</code> indicates that we want the contents of the file to sent instead of the actual file. Finally, <code>-o</code> specifies the output file.</p>

<h2 id="update-feb-28-2016-blog-post-on-authentication">Update Feb 28 2016 - Blog post on authentication</h2>

<p>I created an <a href="/blog/alexa-voice-service-authentication">Alexa Voice Service Authencation</a> blog post since I have been getting a lot of requests on how to do the authentication step.</p>

<h2 id="update-may-8-2018-api-changes">Update May 8 2018 - API Changes</h2>

<p>There have been major updates made to the Alexa AVS API so this article is now out-of-date. The best place to ask for help would be in the <a href="https://forums.developer.amazon.com/spaces/165/alexa.html">Alexa Developer Forums</a>.</p>
<ul class="pa0">
  
   <li class="list">
     <a href="/tags/avs" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">AVS</a>
   </li>
  
   <li class="list">
     <a href="/tags/alexa" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Alexa</a>
   </li>
  
   <li class="list">
     <a href="/tags/amazon" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Amazon</a>
   </li>
  
   <li class="list">
     <a href="/tags/curl" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">cURL</a>
   </li>
  
</ul>
<div class="mt6">
        
      </div>
    </section>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://example.org/" >
    &copy; 2019 My New Hugo Site
  </a>
    <div>










</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
